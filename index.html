<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>LIMENWALKER WORKSHOP</title>

<!-- A2HS 전체화면 & 테마 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --vwpx:100vw; --vhpx:100vh;
    --gap:32px; --line-color:rgba(255,255,255,.9);
    --line-w:1px; --line-r:2px;
    --ff:"Courier New", Courier, monospace;
  }
  html,body{
    margin:0;height:100%;background:#000;color:#fff;
    font-family:var(--ff); overflow:hidden;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  *,*::before,*::after{ box-sizing:border-box; font-family:var(--ff); }
  button,input,select,textarea{ font:inherit; color:inherit; }

  /* 레이어 스택: 카메라(0) ← 궤적(2) ← 레졸룸(4) ← UI(10) */
  #cameraView{
    position:fixed; inset:0;
    width:var(--vwpx); height:var(--vhpx);
    object-fit:cover; background:#000; z-index:0;
    filter:grayscale(1) contrast(1.2);
    will-change: transform, opacity; transform: translateZ(0);
    backface-visibility: hidden;
  }
  #trailCanvas{
    position:fixed; inset:0;
    width:var(--vwpx); height:var(--vhpx);
    z-index:2; pointer-events:none; background:transparent;
    will-change: opacity;
  }
  #ninjaOverlay{
    position:fixed; left:50%; top:50%;
    width:var(--vwpx); height:var(--vhpx);
    transform:translate(-50%,-50%) scale(1); transform-origin:50% 50%;
    border:0; background:transparent; image-rendering:auto;
    z-index:4; pointer-events:none; opacity:0; transition:opacity .25s ease;
    mix-blend-mode: lighten;
    will-change: opacity, transform;
  }

  .proscenium{
    position:fixed;
    left:calc(var(--gap) + env(safe-area-inset-left));
    right:calc(var(--gap) + env(safe-area-inset-right));
    top:calc(var(--gap) + env(safe-area-inset-top));
    bottom:calc(var(--gap) + env(safe-area-inset-bottom));
    border:var(--line-w) solid var(--line-color);
    border-radius:var(--line-r);
    pointer-events:none; z-index:5;
  }

  /* 중앙 안내(터치 통과) */
  #infoText, #overlay{
    position:fixed; inset:0; display:flex;
    align-items:center; justify-content:center; flex-direction:column;
    text-align:center;
  }
  #infoText{
    font-size:clamp(14px,2vmin,18px); opacity:.88; z-index:8;
    pointer-events:none; /* ★ 이벤트 통과, 중앙 고정 */
  }

  #overlay{
    background:rgba(0,0,0,.65);
    z-index:10; line-height:1.6;
    transition:opacity .25s ease;
  }
  #overlay.hidden{ opacity:0; pointer-events:none; }
  .centerText{ text-align:center; white-space:pre-line; font-size:clamp(16px,2.6vmin,24px); }
  .stageText{ text-align:left; white-space:pre-line; max-width:90vw; font-size:clamp(14px,2vmin,20px); }
  .stageBtn{
    border:1px solid #fff; background:transparent; color:#fff;
    padding:.6em 1.4em; text-transform:uppercase; margin-top:18px;
    font-size:clamp(14px,2vmin,20px); cursor:pointer;
  }
  #countdown{ font-size:clamp(12px,1.8vmin,16px); opacity:.8; margin-top:14px; display:none; }
</style>
</head>
<body>

<video id="cameraView" autoplay muted playsinline></video>
<canvas id="trailCanvas"></canvas>

<iframe id="ninjaOverlay"
  allow="autoplay; camera; microphone; fullscreen; clipboard-read; clipboard-write"
  allowtransparency="true" referrerpolicy="no-referrer" src="about:blank">
</iframe>

<div class="proscenium" aria-hidden="true"></div>

<div id="infoText">
  프로그램 시작을 위해 화면을 터치한 후<br>
  카메라, 마이크, 위치 센서 허용을 눌러주세요.
</div>

<div id="overlay" class="hidden">
  <div id="msg" class="centerText"></div>
  <button id="startBtn" class="stageBtn" style="display:none;">PRESS HERE TO START</button>
  <div id="countdown"></div>
</div>

<script>
(()=> {
/* ===== Config ===== */
const CONFIG = {
  ROOM_ID: "YOURROOMID",
  REZ_SCALE: 0.65,     // 레졸룸 소스 렌더 스케일(품질/부하 트레이드오프)
  LINE_WIDTH: 0.6,     // ★ 더 얇은 점선
  LINE_DASH: [1.5,10],

  /* 상태별 레이어 비율(0~1) — 합이 1일 필요는 없음(독립 알파) */
  LAYERS: {
    WELCOME: { CAMERA: 1.00, NINJA: 0.18, TRAIL: 0.00 },
    GUIDE:   { CAMERA: 1.00, NINJA: 0.18, TRAIL: 0.00 },
    WALK:    { CAMERA: 0.95, NINJA: 0.18, TRAIL: 0.85 },
    STOP:    { CAMERA: 0.95, NINJA: 0.15, TRAIL: 0.65 },
  }
};

/* ===== Elements ===== */
const camView   = document.getElementById('cameraView');
const trail     = document.getElementById('trailCanvas');
const tctx      = trail.getContext('2d');
const ninja     = document.getElementById('ninjaOverlay');
const overlay   = document.getElementById('overlay');
const msg       = document.getElementById('msg');
const startBtn  = document.getElementById('startBtn');
const infoText  = document.getElementById('infoText');
const countdown = document.getElementById('countdown');

/* ===== Viewport fix ===== */
function setViewportVars(){
  const vv = window.visualViewport;
  const w = Math.round((vv?.width || innerWidth));
  const h = Math.round((vv?.height || innerHeight));
  document.documentElement.style.setProperty('--vwpx', w + 'px');
  document.documentElement.style.setProperty('--vhpx', h + 'px');

  const dpr = Math.max(1, devicePixelRatio || 1);
  trail.width  = Math.floor(w * dpr);
  trail.height = Math.floor(h * dpr);
  trail.style.width  = w + 'px';
  trail.style.height = h + 'px';
  tctx.setTransform(dpr,0,0,dpr,0,0);
}
setViewportVars();
addEventListener('resize', setViewportVars);
if (visualViewport){
  visualViewport.addEventListener('resize', setViewportVars);
  visualViewport.addEventListener('scroll', setViewportVars);
}
addEventListener('orientationchange', ()=> setTimeout(setViewportVars,120));
addEventListener('pageshow', ()=>{ setTimeout(()=>{ setViewportVars(); applyRezScale(); }, 60); });

/* ===== Audio ===== */
let audioCtx;
function initAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
}
function beep(freq=880, dur=150){
  try{
    initAudioContext();
    const osc = audioCtx.createOscillator(), g = audioCtx.createGain();
    osc.type='square'; osc.frequency.value=freq; g.gain.value=0.0001;
    osc.connect(g).connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.25,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur/1000);
    osc.start(t); osc.stop(t+dur/1000+0.02);
  }catch{}
}

/* ===== Wake Lock ===== */
let wakeLock = null;
async function keepScreenOn(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      document.addEventListener('visibilitychange', async ()=>{
        if(document.visibilityState==='visible' && !wakeLock){
          try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{}
        }
      });
    }
  }catch{}
}

/* ===== Overlay helpers ===== */
function showOverlayText(text, center=true){
  msg.className = center ? 'centerText' : 'stageText';
  msg.textContent = text;
  overlay.classList.remove('hidden');
}
function hideOverlay(){ overlay.classList.add('hidden'); }

/* ===== VDO.Ninja ===== */
const injectedCss = encodeURIComponent(`
  html,body{background:transparent!important;margin:0!important;overflow:hidden!important;}
  #container,.container{background:transparent!important;}
  video,canvas{position:fixed!important; inset:0!important; width:100vw!important; height:100vh!important; object-fit:cover!important; background:transparent!important;}
`);
const ninjaBase = `https://vdo.ninja/?view=${encodeURIComponent(CONFIG.ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo&transparent=1&css=${injectedCss}`;
const ninjaUrl  = () => `${ninjaBase}&ts=${Date.now()}`;

function applyRezScale(){
  const s = Math.max(0.2, Math.min(1, Number(CONFIG.REZ_SCALE)||1));
  ninja.style.width = `calc(var(--vwpx) * ${s})`;
  ninja.style.height = `calc(var(--vhpx) * ${s})`;
  ninja.style.left = '50%'; ninja.style.top = '50%';
  ninja.style.transform = `translate(-50%,-50%) scale(${1/s})`;
}
applyRezScale();

/* ===== Layer ratio control ===== */
let state = 'WELCOME';
function applyLayerMix(){
  const M = CONFIG.LAYERS[state] || CONFIG.LAYERS.WELCOME;
  camView.style.opacity = String(M.CAMERA);
  ninja.style.opacity   = String(M.NINJA);
  trail.style.opacity   = String(M.TRAIL);
}

/* ===== Sensors & Trajectory ===== */
let gpsWatchId = null, firstFix = null, points = [];
let drawingEnabled = false;
let metersPerPixel = 1.2;
const MAX_POINTS = 2500;
const DECAY_START = 10_000, MAX_AGE = 60_000, MAX_JITTER = 18;

let motionMag = 0;
function onMotion(e){
  const ax = e.accelerationIncludingGravity?.x || 0;
  const ay = e.accelerationIncludingGravity?.y || 0;
  const az = e.accelerationIncludingGravity?.z || 0;
  const mag = Math.hypot(ax, ay, az);
  motionMag = motionMag * 0.9 + mag * 0.1;
}
function enableMotionIfNeeded(){
  try{
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function'){
      DeviceMotionEvent.requestPermission().catch(()=>{});
    }
  }catch(e){}
  addEventListener('devicemotion', onMotion, {passive:true});
}
const M_PER_DEG = 111320;
function llToMeters(lat0, lon0, lat, lon){
  const x = (lon - lon0) * Math.cos(lat0 * Math.PI/180) * M_PER_DEG;
  const y = (lat - lat0) * M_PER_DEG;
  return {x, y};
}
function metersToCanvas(xm, ym){
  const w = trail.clientWidth, h = trail.clientHeight;
  const cx = w/2, cy = h/2;
  return { x: cx + xm / metersPerPixel, y: cy - ym / metersPerPixel };
}
function startGPS(){
  if(!('geolocation' in navigator)) return;
  firstFix = null;
  gpsWatchId = navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat, longitude:lon, speed} = pos.coords;
      if(!firstFix){ firstFix = {lat, lon}; }
      const m  = llToMeters(firstFix.lat, firstFix.lon, lat, lon);
      const p  = metersToCanvas(m.x, m.y);
      points.push({ x:p.x, y:p.y, t:performance.now(), speed:(Number.isFinite(speed)?speed:0)||0 });
      if(points.length > MAX_POINTS) points.shift();
    }, ()=>{}, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
  );
}
function jitterFor(age){
  const frac = Math.min(1, Math.max(0, (age-DECAY_START)/(MAX_AGE-DECAY_START)));
  const motionBoost = Math.min(1, Math.max(0, (motionMag-5)/10));
  return (MAX_JITTER * frac) * (0.5 + 0.5*motionBoost);
}
function drawTrajectory(){
  const now = performance.now();
  // ★ 잔상 바탕 알파(낮을수록 선명)
  tctx.fillStyle = 'rgba(0,0,0,0.06)';
  tctx.fillRect(0,0,trail.clientWidth, trail.clientHeight);
  if(points.length < 2 || !drawingEnabled) return;
  tctx.save();
  tctx.lineWidth = CONFIG.LINE_WIDTH;
  tctx.setLineDash(CONFIG.LINE_DASH);
  for(let i=1;i<points.length;i++){
    const a = points[i-1], b = points[i];
    const age = now - b.t;
    if(age > MAX_AGE) continue;
    const alpha = age <= DECAY_START ? 0.9 : Math.max(0, 0.9 * (1 - (age-DECAY_START)/(MAX_AGE-DECAY_START)));
    const j = age > DECAY_START ? jitterFor(age) : 0;
    const jx1=(Math.random()-0.5)*2*j, jy1=(Math.random()-0.5)*2*j;
    const jx2=(Math.random()-0.5)*2*j, jy2=(Math.random()-0.5)*2*j;
    tctx.strokeStyle = `rgba(255,255,255,${alpha})`;
    tctx.beginPath();
    tctx.moveTo(a.x + jx1, a.y + jy1);
    tctx.lineTo(b.x + jx2, b.y + jy2);
    tctx.stroke();
  }
  tctx.restore();
  const cutoff = now - MAX_AGE;
  if(points.length && points[0].t < cutoff){
    let idx = 0; while(idx < points.length && points[idx].t < cutoff) idx++;
    if(idx>0) points.splice(0, idx);
  }
}
let rafId=null; function loop(){ drawTrajectory(); rafId = requestAnimationFrame(loop); }

/* ===== 카메라/마이크 분리 + 워치독 ===== */
let currentStream = null, ensureTimer = null, restartTimer = null;
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } },
    audio: false
  });
  currentStream = stream;
  camView.srcObject = stream;
  camView.muted = true;
  camView.setAttribute('playsinline','');
  camView.load();
  try { await camView.play(); } catch {}
  bindTrackGuards(stream);
  pingEnsurePlaying();
}
async function startMic(){ try{ await navigator.mediaDevices.getUserMedia({ audio:true }); }catch{} }
function bindTrackGuards(stream){
  stream.getVideoTracks().forEach(tr=>{
    tr.onended  = ()=>{ restartCameraSoon(); };
    tr.onmute   = ()=>{ pingEnsurePlaying(); };
    tr.onunmute = ()=>{ pingEnsurePlaying(); };
  });
}
function restartCameraSoon(ms=350){
  if(restartTimer) return;
  restartTimer = setTimeout(async ()=>{
    restartTimer=null;
    try{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); }catch{}
    currentStream=null;
    try{ await startCamera(); }catch(e){ console.error('restart camera fail',e); }
  }, ms);
}
function pingEnsurePlaying(){
  if(ensureTimer) return;
  ensureTimer = setInterval(()=>{
    if(camView.readyState >= 2 && camView.paused){ camView.play().catch(()=>{}); }
    const ok = currentStream && currentStream.getVideoTracks().some(t=>t.readyState==='live');
    if(!ok) restartCameraSoon(100);
  }, 1000);
}

/* ===== Input binder ===== */
function onPress(el, handler){
  let fired=false;
  const wrap=(e)=>{ if(fired) return; fired=true; e.preventDefault(); e.stopPropagation(); handler(); };
  el.addEventListener('touchend', wrap, { once:true, passive:false });
  el.addEventListener('click', wrap, { once:true });
}

/* ===== Flow ===== */
onPress(window, async ()=>{
  initAudioContext(); keepScreenOn();
  infoText.style.display='none';

  await startCamera().catch(e=>console.error('camera start fail',e));
  enableMotionIfNeeded(); startGPS(); if(!rafId) loop();

  applyRezScale();
  if(!ninja.contentWindow) ninja.src = ninjaUrl();

  state='WELCOME'; applyLayerMix();
  stepWelcome();
});

function stepWelcome(){
  showOverlayText('WELCOME TO LIMENWALKER WORKSHOP', true);
  setTimeout(()=>{
    beep(880,120);
    document.getElementById('msg').textContent='';
    countdown.style.display='none';
    startBtn.style.display='inline-block';
    state='WELCOME'; applyLayerMix(); // 유지
  },3000);
}

let guideTimer=null;
onPress(startBtn, async ()=>{
  if(guideTimer) return;
  beep(660,150);
  startBtn.style.display='none';
  await startMic().catch(()=>{});
  showOverlayText(formatGuide(), false);

  state='GUIDE'; applyLayerMix();

  let sec=60;
  countdown.style.display='block';
  countdown.textContent=`${sec}초 후 탐사가 시작됩니다.`;
  guideTimer=setInterval(()=>{
    sec--;
    countdown.textContent=`${sec}초 후 탐사가 시작됩니다.`;
    if(sec<=0){
      clearInterval(guideTimer); guideTimer=null;
      countdown.style.display='none';
      stepWalkStop();
    }
  },1000);
});

function stepWalkStop(){
  drawingEnabled = true;

  state='WALK'; applyLayerMix();
  showOverlayText('WALK : 공간을 걸어보세요.', true);

  setTimeout(()=>{
    state='STOP'; applyLayerMix();
    showOverlayText('STOP : 공간에 멈춰 주변을 살피세요.', true);
    setTimeout(()=>{ hideOverlay(); }, 3000);
  },3000);
}

/* 안내문 */
function formatGuide(){
  const lines = [
    "안녕하세요. 리멘워커 워크숍의 첫 번째 워크숍 발표를 찾아와주신 여러분에게 감사의 인사를 올립니다.",
    "이곳은 무작위로 수집된 시간이 이성적으로 분류되어 예측가능한 현실로 구성된 공간입니다.",
    "어느 날, 이곳에 존재하던 ‘무작위로 수집된 시간’은 예측가능한 현실로부터 탈출하게 됩니다.",
    "잠시후, 당신의 핸드폰 스크린 위로는 ‘당신이 바라보는 현실 공간’과 ‘이 공간을 탈출한 ‘시간’이 바라보는 공간’이 동시에 투사될 것입니다.",
    "3분 간의 시간 동안 당신은 공간을 자유롭게 거닐며, 이 공간을 탈출한 ‘시간’이 바라보는 공간’이 함께 포착해 나가시면 됩니다."
  ];
  return lines.map((l,i)=>`${i+1}. ${l}`).join("\n\n");
}

/* 복귀/회전 시 UI & 레이어 재적용 */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){
    setViewportVars(); applyRezScale();
    camView.play().catch(()=>{});
    if(!currentStream){ restartCameraSoon(50); }
    applyLayerMix();                          // ★ 현재 상태 비율 그대로 재적용
    if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); }
  }
});
window.addEventListener('orientationchange', ()=>{
  setTimeout(()=>{
    setViewportVars(); applyRezScale();
    camView.play().catch(()=>{});
    if(!currentStream){ restartCameraSoon(50); }
    applyLayerMix();
  },120);
});

})();
</script>
</body>
</html>
