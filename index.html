<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>LIMENWALKER WORKSHOP</title>

<!-- A2HS ì „ì²´í™”ë©´ & í…Œë§ˆ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --vwpx:100vw; --vhpx:100vh; /* JSì—ì„œ ì‹¤ì¹˜ìˆ˜ë¡œ ë®ì–´ì”€ */
    --gap:32px; --line-color:rgba(255,255,255,.9);
    --line-w:1px; --line-r:2px;
    --ff:"Courier New", Courier, monospace;
  }
  html,body{
    margin:0;height:100%;background:#000;color:#fff;
    font-family:var(--ff); overflow:hidden;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  *,*::before,*::after{ box-sizing:border-box; }

  /* ì¹´ë©”ë¼ ë·° */
  #cameraView{
    position:fixed; left:0; top:0; width:var(--vwpx); height:var(--vhpx);
    object-fit:cover; background:#000; z-index:0;
    filter:grayscale(1) contrast(1.2);
    /* iOS í•©ì„± ë¸”ë­í‚¹ íšŒí”¼ */
    will-change: transform;
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  /* ê¶¤ì  ìº”ë²„ìŠ¤ (ì¹´ë©”ë¼ ìœ„, ì˜¤ë²„ë ˆì´/í”„ë¡œì‹œë‹ˆì—„ ì•„ë˜) */
  #trailCanvas{
    position:fixed; left:0; top:0; width:var(--vwpx); height:var(--vhpx);
    z-index:2; pointer-events:none; background:transparent;
  }

  /* VDO.Ninja ì˜¤ë²„ë ˆì´ (ë ˆì¡¸ë£¸) */
  #ninjaOverlay{
    position:fixed; left:50%; top:50%;
    width:var(--vwpx); height:var(--vhpx);
    transform:translate(-50%,-50%) scale(1); transform-origin:50% 50%;
    border:0; background:transparent; image-rendering:auto;
    z-index:4; pointer-events:none; opacity:0; transition:opacity .35s ease;
    mix-blend-mode: lighten; /* ì¹´ë©”ë¼ë¥¼ ëœ ë®ë„ë¡ */
  }

  /* í”„ë¡œì‹œë‹ˆì—„ */
  .proscenium{
    position:fixed;
    left:calc(var(--gap) + env(safe-area-inset-left));
    right:calc(var(--gap) + env(safe-area-inset-right));
    top:calc(var(--gap) + env(safe-area-inset-top));
    bottom:calc(var(--gap) + env(safe-area-inset-bottom));
    border:var(--line-w) solid var(--line-color);
    border-radius:var(--line-r);
    pointer-events:none; z-index:5;
  }

  /* ì¤‘ì•™ ê²€ì •ë°•ìŠ¤ */
  #overlay{
    position:fixed; left:0; top:0; width:var(--vwpx); height:var(--vhpx);
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:rgba(0,0,0,.65); /* ì‹œì•¼ í™•ë³´ */
    z-index:10; text-align:center; line-height:1.6;
    transition:opacity .35s ease;
  }
  #overlay.hidden{ opacity:0; pointer-events:none; }
  .centerText{ text-align:center; white-space:pre-line; font-size:clamp(16px,2.6vmin,24px); }
  .stageText{ text-align:left; white-space:pre-line; max-width:90vw; font-size:clamp(14px,2vmin,20px); }
  .stageBtn{
    border:1px solid #fff; background:transparent; color:#fff;
    padding:.6em 1.4em; text-transform:uppercase; margin-top:18px;
    font-size:clamp(14px,2vmin,20px); cursor:pointer;
  }

  /* ì²˜ìŒ ì•ˆë‚´(ê²€ì •ë°•ìŠ¤ ì•„ë‹˜ â†’ ì „ì²´ í™”ë©´ ì¤‘ì•™) */
  #infoText{
    position:fixed; left:0; top:0; width:var(--vwpx); height:var(--vhpx);
    display:flex; align-items:center; justify-content:center; text-align:center;
    font-size:clamp(14px,2vmin,18px); opacity:.88; z-index:8; pointer-events:auto;
  }

  #countdown{
    font-size:clamp(12px,1.8vmin,16px); opacity:.8; margin-top:14px; text-align:center; display:none;
  }
</style>
</head>
<body>

<!-- ì‹¤ì‹œê°„ ì¹´ë©”ë¼(í›„ë©´) -->
<video id="cameraView" autoplay muted playsinline></video>

<!-- ê¶¤ì  ìº”ë²„ìŠ¤ -->
<canvas id="trailCanvas"></canvas>

<!-- VDO.Ninja(ë ˆì¡¸ë£¸) -->
<iframe id="ninjaOverlay"
  allow="autoplay; camera; microphone; fullscreen; clipboard-read; clipboard-write"
  allowtransparency="true" referrerpolicy="no-referrer" src="about:blank">
</iframe>

<div class="proscenium" aria-hidden="true"></div>

<!-- (ê²€ì •ë°•ìŠ¤ ì•„ë‹˜) ì²˜ìŒ ì•ˆë‚´ -->
<div id="infoText">
  í”„ë¡œê·¸ë¨ ì‹œì‘ì„ ìœ„í•´ í™”ë©´ì„ í„°ì¹˜í•œ í›„<br>
  ì¹´ë©”ë¼, ë§ˆì´í¬, ìœ„ì¹˜ ì„¼ì„œ í—ˆìš©ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
</div>

<!-- ê²€ì •ë°•ìŠ¤ -->
<div id="overlay" class="hidden">
  <div id="msg" class="centerText"></div>
  <button id="startBtn" class="stageBtn" style="display:none;">PRESS HERE TO START</button>
  <div id="countdown"></div>
</div>

<script>
(()=> {
/* ===== Config ===== */
const CONFIG = {
  ROOM_ID: "YOURROOMID",
  REZ_SCALE: 0.65,
  BLEND_WELCOME: 0.0,  // WELCOME/ì•ˆë‚´ë¬¸: ìˆ¨ê¹€
  BLEND_WALK:   0.18,  // WALK: ì‚´ì§ í‘œì‹œ
  BLEND_STOP:   0.15   // STOP: ë” ë‚®ê²Œ
};

/* ===== Elements ===== */
const camView   = document.getElementById('cameraView');
const trail     = document.getElementById('trailCanvas');
const tctx      = trail.getContext('2d');
const ninja     = document.getElementById('ninjaOverlay');
const overlay   = document.getElementById('overlay');
const msg       = document.getElementById('msg');
const startBtn  = document.getElementById('startBtn');
const infoText  = document.getElementById('infoText');
const countdown = document.getElementById('countdown');

/* ===== Viewport fix for A2HS ===== */
function setViewportVars(){
  const vv = window.visualViewport;
  const w = Math.round((vv?.width || window.innerWidth));
  const h = Math.round((vv?.height || window.innerHeight));
  document.documentElement.style.setProperty('--vwpx', w + 'px');
  document.documentElement.style.setProperty('--vhpx', h + 'px');

  // ìº”ë²„ìŠ¤ DPR ë¦¬ì‚¬ì´ì§•
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  trail.width  = Math.floor(w * dpr);
  trail.height = Math.floor(h * dpr);
  trail.style.width  = w + 'px';
  trail.style.height = h + 'px';
  tctx.setTransform(dpr,0,0,dpr,0,0);
}
setViewportVars();
window.addEventListener('resize', setViewportVars);
if (window.visualViewport){
  visualViewport.addEventListener('resize', setViewportVars);
  visualViewport.addEventListener('scroll', setViewportVars);
}
window.addEventListener('orientationchange', ()=>{ setTimeout(setViewportVars, 120); });

/* ===== Audio ===== */
let audioCtx;
function initAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
}
function beep(freq=880, dur=150){
  try{
    initAudioContext();
    const osc = audioCtx.createOscillator(), g = audioCtx.createGain();
    osc.type='square'; osc.frequency.value=freq; g.gain.value=0.0001;
    osc.connect(g).connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.25,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur/1000);
    osc.start(t); osc.stop(t+dur/1000+0.02);
  }catch{}
}

/* ===== Wake Lock (í™”ë©´ êº¼ì§ ë°©ì§€) ===== */
let wakeLock = null;
async function keepScreenOn(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      document.addEventListener('visibilitychange', async ()=>{
        if(document.visibilityState==='visible' && !wakeLock){
          try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{}
        }
      });
    }
  }catch{}
}

/* ===== Overlay helpers ===== */
function showOverlayText(text, center=true){
  msg.className = center ? 'centerText' : 'stageText';
  msg.textContent = text;
  overlay.classList.remove('hidden');
}
function hideOverlay(){ overlay.classList.add('hidden'); }

/* ===== VDO.Ninja (ë ˆì¡¸ë£¸) ===== */
const injectedCss = encodeURIComponent(`
  html,body{background:transparent!important;margin:0!important;overflow:hidden!important;}
  #container,.container{background:transparent!important;}
  video,canvas{position:fixed!important; inset:0!important; width:100vw!important; height:100vh!important; object-fit:cover!important; background:transparent!important;}
`);
const ninjaBase = `https://vdo.ninja/?view=${encodeURIComponent(CONFIG.ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo&transparent=1&css=${injectedCss}`;
const ninjaUrl  = () => `${ninjaBase}&ts=${Date.now()}`;

function applyRezScale(){
  const s = Math.max(0.2, Math.min(1, Number(CONFIG.REZ_SCALE)||1));
  ninja.style.width = `calc(var(--vwpx) * ${s})`;
  ninja.style.height = `calc(var(--vhpx) * ${s})`;
  ninja.style.left = '50%'; ninja.style.top = '50%';
  ninja.style.transform = `translate(-50%,-50%) scale(${1/s})`;
}
applyRezScale();
setInterval(()=>{ if(ninja.style.opacity !== '0'){ ninja.src = ninjaUrl(); } }, 60000);

function setNinjaBlend(alpha=0){
  ninja.style.opacity = '0'; void ninja.offsetHeight; // íŠ¸ëœì§€ì…˜ ë³´ì¥
  ninja.style.opacity = String(alpha);
}

/* ===== Sensors & Trajectory ===== */
let gpsWatchId = null;
let firstFix = null;     // {lat, lon}
let points = [];         // {x, y, t, speed}
let drawingEnabled = false;
let metersPerPixel = 1.2;   // í™”ë©´ ìŠ¤ì¼€ì¼(ìˆ˜ì • ê°€ëŠ¥)
const MAX_POINTS = 2500;

const DECAY_START = 10_000; // 10ì´ˆ í›„ë¶€í„° í•´ì²´ ì‹œì‘
const MAX_AGE     = 60_000; // 60ì´ˆ í›„ ì™„ì „ ì†Œë©¸
const MAX_JITTER  = 18;     // px (ë‚˜ì´ ê¸°ë°˜ ì§€í„° ìƒí•œ)
const BASE_DASH   = [2, 8]; // ì–‡ê³  ì´˜ì´˜í•œ ì ì„ 

// ê°€ì†ë„(ì¤‘ë ¥ í¬í•¨) í¬ê¸° â†’ ì§€í„° ë³´ì • ì°¸ê³ ìš©
let motionMag = 0;
function onMotion(e){
  const ax = e.accelerationIncludingGravity?.x || 0;
  const ay = e.accelerationIncludingGravity?.y || 0;
  const az = e.accelerationIncludingGravity?.z || 0;
  const mag = Math.hypot(ax, ay, az);
  motionMag = motionMag * 0.9 + mag * 0.1;
}
function enableMotionIfNeeded(){
  try{
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function'){
      DeviceMotionEvent.requestPermission().catch(()=>{});
    }
  }catch(e){}
  window.addEventListener('devicemotion', onMotion, {passive:true});
}

// ìœ„ê²½ë„ â†’ ì‹œì‘ ì§€ì  ê¸°ì¤€ ìƒëŒ€ ë¯¸í„°
const M_PER_DEG = 111320;
function llToMeters(lat0, lon0, lat, lon){
  const x = (lon - lon0) * Math.cos(lat0 * Math.PI/180) * M_PER_DEG;
  const y = (lat - lat0) * M_PER_DEG;
  return {x, y};
}
// ë¯¸í„° â†’ í™”ë©´ ì¢Œí‘œ
function metersToCanvas(xm, ym){
  const w = trail.clientWidth, h = trail.clientHeight;
  const cx = w/2, cy = h/2; // í™”ë©´ ì¤‘ì•™ì„ (0,0)ì²˜ëŸ¼
  return { x: cx + xm / metersPerPixel, y: cy - ym / metersPerPixel };
}

function startGPS(){
  if(!('geolocation' in navigator)) return;
  firstFix = null;
  gpsWatchId = navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat, longitude:lon, speed} = pos.coords;
      if(!firstFix){ firstFix = {lat, lon}; }
      const m  = llToMeters(firstFix.lat, firstFix.lon, lat, lon);
      const p  = metersToCanvas(m.x, m.y);
      points.push({
        x: p.x, y: p.y,
        t: performance.now(),
        speed: (Number.isFinite(speed) ? speed : 0) || 0
      });
      if(points.length > MAX_POINTS) points.shift();
    },
    err=>{ /* silent; ì‹¤ë‚´ì—ì„œ í”í•¨ */ },
    { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
  );
}
function stopGPS(){
  if(gpsWatchId!=null){ navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId=null; }
}

// ëœë¤ ì§€í„°(ë‚˜ì´/ê°€ì† ê¸°ë°˜)
function jitterFor(age){
  const frac = Math.min(1, Math.max(0, (age-DECAY_START)/(MAX_AGE-DECAY_START)));
  const motionBoost = Math.min(1, Math.max(0, (motionMag-5)/10)); // ëŒ€ëµì  ë³´ì •
  return (MAX_JITTER * frac) * (0.5 + 0.5*motionBoost);
}

function drawTrajectory(){
  const now = performance.now();
  // ì”ìƒ ëŠë‚Œ
  tctx.fillStyle = 'rgba(0,0,0,0.06)';
  tctx.fillRect(0,0,trail.clientWidth, trail.clientHeight);

  if(points.length < 2 || !drawingEnabled) return;

  tctx.save();
  tctx.lineWidth = 0.8;          // ë” ì–‡ê²Œ
  tctx.setLineDash(BASE_DASH);   // ì´˜ì´˜
  for(let i=1;i<points.length;i++){
    const a = points[i-1], b = points[i];
    const age = now - b.t;

    if(age > MAX_AGE) continue;

    const alpha =
      age <= DECAY_START ? 0.9
      : Math.max(0, 0.9 * (1 - (age-DECAY_START)/(MAX_AGE-DECAY_START)));

    // ì§€í„°
    const j = age > DECAY_START ? jitterFor(age) : 0;
    const jx1 = (Math.random()-0.5)*2*j;
    const jy1 = (Math.random()-0.5)*2*j;
    const jx2 = (Math.random()-0.5)*2*j;
    const jy2 = (Math.random()-0.5)*2*j;

    tctx.strokeStyle = `rgba(255,255,255,${alpha})`;
    tctx.beginPath();
    tctx.moveTo(a.x + jx1, a.y + jy1);
    tctx.lineTo(b.x + jx2, b.y + jy2);
    tctx.stroke();
  }
  tctx.restore();

  // ì˜¤ë˜ëœ í¬ì¸íŠ¸ ì •ë¦¬
  const cutoff = now - MAX_AGE;
  if(points.length && points[0].t < cutoff){
    let idx = 0;
    while(idx < points.length && points[idx].t < cutoff) idx++;
    if(idx>0) points.splice(0, idx);
  }
}

let rafId = null;
function loop(){
  drawTrajectory();
  rafId = requestAnimationFrame(loop);
}

/* ===== ì¹´ë©”ë¼/ë§ˆì´í¬ ë¶„ë¦¬ + ì›Œì¹˜ë… ===== */
let currentStream = null;
let ensureTimer = null;
let restartTimer = null;

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } }, // í›„ë©´ ìš°ì„ 
    audio: false
  });
  currentStream = stream;                 // ì°¸ì¡° ìœ ì§€
  camView.srcObject = stream;
  camView.muted = true;
  camView.setAttribute('playsinline','');
  camView.load();
  try { await camView.play(); } catch {}
  bindTrackGuards(stream);
  pingEnsurePlaying();
}

async function startMic(){
  try { await navigator.mediaDevices.getUserMedia({ audio:true }); } catch {}
}

function bindTrackGuards(stream){
  stream.getVideoTracks().forEach(tr=>{
    tr.onended  = ()=>{ console.warn('Video ended'); restartCameraSoon(); };
    tr.onmute   = ()=>{ console.warn('Video muted'); pingEnsurePlaying(); };
    tr.onunmute = ()=>{ console.warn('Video unmuted'); pingEnsurePlaying(); };
  });
}

function restartCameraSoon(ms=350){
  if(restartTimer) return;
  restartTimer = setTimeout(async ()=>{
    restartTimer=null;
    try{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); }catch{}
    currentStream=null;
    try{ await startCamera(); }catch(e){ console.error('restart camera fail',e); }
  }, ms);
}

function pingEnsurePlaying(){
  if(ensureTimer) return;
  ensureTimer = setInterval(()=>{
    if(camView.readyState >= 2 && camView.paused){
      camView.play().catch(()=>{});
    }
    const ok = currentStream && currentStream.getVideoTracks().some(t=>t.readyState==='live');
    if(!ok) restartCameraSoon(100);
  }, 1000);
}

/* ===== Input binder (ë”ë¸” íŠ¸ë¦¬ê±° ë°©ì§€) ===== */
function onPress(el, handler){
  let fired = false;
  const wrap = (e)=>{ if(fired) return; fired=true; e.preventDefault(); e.stopPropagation(); handler(); };
  el.addEventListener('touchend', wrap, { once:true, passive:false });
  el.addEventListener('click', wrap, { once:true });
}

/* ===== Flow ===== */
/* 1) ì²« í„°ì¹˜: ì˜¤ë””ì˜¤ init + í™”ë©´ìœ ì§€ + ì¹´ë©”ë¼(on) + ì„¼ì„œ ìˆ˜ì§‘ + ë ˆì¡¸ë£¸ src ë¡œë“œ(ìˆ¨ê¹€) â†’ WELCOME */
onPress(window, async ()=>{
  initAudioContext();
  keepScreenOn();
  infoText.style.display='none';

  try{ await startCamera(); }catch(e){ console.error('camera start fail',e); }
  enableMotionIfNeeded(); startGPS(); if(!rafId) loop();

  applyRezScale();
  if(!ninja.contentWindow) ninja.src = ninjaUrl(); // ì†ŒìŠ¤ë§Œ ë¡œë“œ
  setNinjaBlend(CONFIG.BLEND_WELCOME);             // ìˆ¨ê¹€

  stepWelcome();
});

/* 2) WELCOME â†’ (3ì´ˆ í›„ ë¹„í”„) â†’ PRESS ë²„íŠ¼(ë¬¸êµ¬ ì—†ì´ ë²„íŠ¼ë§Œ) */
function stepWelcome(){
  showOverlayText('WELCOME TO LIMENWALKER WORKSHOP', true);
  setTimeout(()=>{
    beep(880,120);
    msg.textContent='';                 // ë¬¸êµ¬ ì œê±°
    countdown.style.display='none';     // íƒ€ì´ë¨¸ëŠ” ì•ˆë‚´ë¬¸ì—ì„œë§Œ
    startBtn.style.display='inline-block';
    setNinjaBlend(CONFIG.BLEND_WELCOME); // ì—¬ì „íˆ ìˆ¨ê¹€
  },3000);
}

/* 3) PRESS â†’ ì•ˆë‚´ë¬¸ + íƒ€ì´ë¨¸(ì—¬ê¸°ì„œë§Œ í‘œì‹œ) + ë§ˆì´í¬ í—ˆìš©(í•„ìš”ì‹œ) */
let guideTimer = null;
onPress(startBtn, async ()=>{
  if(guideTimer) return;   // ì¬ì§„ì… ë°©ì§€
  beep(660,150);
  startBtn.style.display='none';
  await startMic().catch(()=>{});       // ë§ˆì´í¬ëŠ” ë¶„ë¦¬ ìš”ì²­
  showOverlayText(formatGuide(), false);
  setNinjaBlend(CONFIG.BLEND_WELCOME);  // ì•ˆë‚´ë¬¸ ë™ì•ˆ ìˆ¨ê¹€

  let sec = 60;
  countdown.style.display='block';
  countdown.textContent = `${sec}ì´ˆ í›„ íƒì‚¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.`;
  guideTimer = setInterval(()=>{
    sec--;
    countdown.textContent = `${sec}ì´ˆ í›„ íƒì‚¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.`;
    if(sec<=0){
      clearInterval(guideTimer); guideTimer = null;
      countdown.style.display='none';
      stepWalkStop();
    }
  }, 1000);
});

/* 4) WALK â†’ 3ì´ˆ í›„ STOP â†’ 3ì´ˆ í›„ ìˆ¨ê¹€ + ì´ë•Œë¶€í„° ì‹œê°í™” í‘œì‹œ ON */
function stepWalkStop(){
  drawingEnabled = true;                 // === ì—¬ê¸°ì„œë¶€í„° ê¶¤ì  í‘œì‹œ ì‹œì‘ ===
  setNinjaBlend(CONFIG.BLEND_WALK);      // ë ˆì¡¸ë£¸ ì‚´ì§ ë³´ì´ê¸°
  showOverlayText('WALK : ê³µê°„ì„ ê±¸ì–´ë³´ì„¸ìš”.', true);

  setTimeout(()=>{
    setNinjaBlend(CONFIG.BLEND_STOP);    // STOPì—ì„œ ë” ë‚®ì¶¤
    showOverlayText('STOP : ê³µê°„ì— ë©ˆì¶° ì£¼ë³€ì„ ì‚´í”¼ì„¸ìš”.', true);
    setTimeout(()=>{ hideOverlay(); /* ë ˆì¡¸ë£¸ì€ ì¼œë‘” ì±„ */ }, 3000);
  }, 3000);
}

/* ì•ˆë‚´ë¬¸(ë„˜ë²„ë§) */
function formatGuide(){
  const lines = [
    "ì•ˆë…•í•˜ì„¸ìš”. ë¦¬ë©˜ì›Œì»¤ ì›Œí¬ìˆì˜ ì²« ë²ˆì§¸ ì›Œí¬ìˆ ë°œí‘œë¥¼ ì°¾ì•„ì™€ì£¼ì‹  ì—¬ëŸ¬ë¶„ì—ê²Œ ê°ì‚¬ì˜ ì¸ì‚¬ë¥¼ ì˜¬ë¦½ë‹ˆë‹¤.",
    "ì´ê³³ì€ ë¬´ì‘ìœ„ë¡œ ìˆ˜ì§‘ëœ ì‹œê°„ì´ ì´ì„±ì ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ì˜ˆì¸¡ê°€ëŠ¥í•œ í˜„ì‹¤ë¡œ êµ¬ì„±ëœ ê³µê°„ì…ë‹ˆë‹¤.",
    "ì–´ëŠ ë‚ , ì´ê³³ì— ì¡´ì¬í•˜ë˜ â€˜ë¬´ì‘ìœ„ë¡œ ìˆ˜ì§‘ëœ ì‹œê°„â€™ì€ ì˜ˆì¸¡ê°€ëŠ¥í•œ í˜„ì‹¤ë¡œë¶€í„° íƒˆì¶œí•˜ê²Œ ë©ë‹ˆë‹¤.",
    "ì ì‹œí›„, ë‹¹ì‹ ì˜ í•¸ë“œí° ìŠ¤í¬ë¦° ìœ„ë¡œëŠ” â€˜ë‹¹ì‹ ì´ ë°”ë¼ë³´ëŠ” í˜„ì‹¤ ê³µê°„â€™ê³¼ â€˜ì´ ê³µê°„ì„ íƒˆì¶œí•œ â€˜ì‹œê°„â€™ì´ ë°”ë¼ë³´ëŠ” ê³µê°„â€™ì´ ë™ì‹œì— íˆ¬ì‚¬ë  ê²ƒì…ë‹ˆë‹¤.",
    "3ë¶„ ê°„ì˜ ì‹œê°„ ë™ì•ˆ ë‹¹ì‹ ì€ ê³µê°„ì„ ììœ ë¡­ê²Œ ê±°ë‹ë©°, ì´ ê³µê°„ì„ íƒˆì¶œí•œ â€˜ì‹œê°„â€™ì´ ë°”ë¼ë³´ëŠ” ê³µê°„â€™ì´ í•¨ê»˜ í¬ì°©í•´ ë‚˜ê°€ì‹œë©´ ë©ë‹ˆë‹¤."
  ];
  return lines.map((l,i)=>`${i+1}. ${l}`).join("\n\n");
}

/* ë³µê·€/íšŒì „ ì‹œ ë¹„ë””ì˜¤ ì¬ìƒ ë³´ì¥ & ë ˆì´ì•„ì›ƒ ë¦¬í”„ë ˆì‹œ */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){
    setViewportVars();
    applyRezScale();
    camView.play().catch(()=>{});   // ğŸ” ì¬ìƒ ì¬ìš”ì²­
    if(!currentStream){ restartCameraSoon(50); }
    if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); }
  }
});
window.addEventListener('orientationchange', ()=>{
  setTimeout(()=>{
    setViewportVars();
    camView.play().catch(()=>{});   // ğŸ” íšŒì „ ë’¤ ì¬ìš”ì²­
    if(!currentStream){ restartCameraSoon(50); }
  },120);
});

/* ===== í˜„ì¥ìš©: 3-íƒ­ìœ¼ë¡œ ë ˆì¡¸ë£¸ ì§„í•˜ê¸° ìˆœí™˜(ì˜µì…˜) ===== */
const cycle = [0, 0.15, 0.30];
let ci = 0, taps=0, last=0;
window.addEventListener('touchend', ()=>{
  const now = Date.now();
  taps = (now-last < 350) ? taps+1 : 1; last = now;
  if(taps>=3){
    ci = (ci+1) % cycle.length;
    setNinjaBlend(cycle[ci]);
    taps = 0;
  }
});

})();
</script>
</body>
</html>
