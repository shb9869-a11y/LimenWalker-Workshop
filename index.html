<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>LIMENWALKER WORKSHOP</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --vwpx:100vw; --vhpx:100vh;
    --gap:32px; --line-color:rgba(255,255,255,.9);
    --line-w:1px; --line-r:2px;
    --ff:"Courier New", Courier, monospace;
  }
  html,body{
    margin:0;height:100%;background:#000;color:#fff;
    font-family:var(--ff); overflow:hidden;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  *,*::before,*::after{ box-sizing:border-box; font-family:var(--ff); }
  button,input,select,textarea{ font:inherit; color:inherit; }

  #cameraView{position:fixed;inset:0;width:var(--vwpx);height:var(--vhpx);object-fit:cover;z-index:0;filter:grayscale(1) contrast(1.2);}
  #trailCanvas{position:fixed;inset:0;width:var(--vwpx);height:var(--vhpx);z-index:2;pointer-events:none;}
  #ninjaOverlay{position:fixed;left:50%;top:50%;width:var(--vwpx);height:var(--vhpx);transform:translate(-50%,-50%) scale(1);
    border:0;background:transparent;z-index:4;pointer-events:none;opacity:0;transition:opacity .25s ease;mix-blend-mode:lighten;}
  .proscenium{position:fixed;left:calc(var(--gap) + env(safe-area-inset-left));right:calc(var(--gap) + env(safe-area-inset-right));
    top:calc(var(--gap) + env(safe-area-inset-top));bottom:calc(var(--gap) + env(safe-area-inset-bottom));
    border:var(--line-w) solid var(--line-color);border-radius:var(--line-r);pointer-events:none;z-index:5;}
  #infoText,#overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;}
  #infoText{font-size:clamp(14px,2vmin,18px);opacity:.88;z-index:8;pointer-events:none;}
  #overlay{background:rgba(0,0,0,.65);z-index:10;line-height:1.6;transition:opacity .25s ease;}
  #overlay.hidden{opacity:0;pointer-events:none;}
  .centerText{white-space:pre-line;font-size:clamp(16px,2.6vmin,24px);}
  .stageBtn{border:1px solid #fff;background:transparent;color:#fff;padding:.6em 1.4em;margin-top:18px;
    font-size:clamp(14px,2vmin,20px);cursor:pointer;}
  #countdown{font-size:clamp(12px,1.8vmin,16px);opacity:.8;margin-top:14px;display:none;}
</style>
</head>
<body>

<video id="cameraView" autoplay muted playsinline></video>
<canvas id="trailCanvas"></canvas>
<iframe id="ninjaOverlay"
  allow="autoplay;camera;microphone;fullscreen;clipboard-read;clipboard-write"
  allowtransparency="true" referrerpolicy="no-referrer" src="about:blank"></iframe>

<div class="proscenium"></div>

<div id="infoText">
  화면을 터치하면<br>카메라와 마이크 권한을 요청합니다.
</div>

<div id="overlay" class="hidden">
  <div id="msg" class="centerText"></div>
  <button id="startBtn" class="stageBtn" style="display:none;">PRESS HERE TO START</button>
  <div id="countdown"></div>
</div>

<script>
(()=>{

const CONFIG={
  ROOM_ID:"YOURROOMID",
  LAYERS:{
    WELCOME:{CAMERA:1.00,NINJA:0.35,TRAIL:0.00},
    GUIDE:{CAMERA:1.00,NINJA:0.35,TRAIL:0.00},
    WALK:{CAMERA:0.95,NINJA:0.30,TRAIL:0.85},
    STOP:{CAMERA:0.95,NINJA:0.25,TRAIL:0.65}
  }
};

const cam=document.getElementById("cameraView");
const ninja=document.getElementById("ninjaOverlay");
const overlay=document.getElementById("overlay");
const msg=document.getElementById("msg");
const startBtn=document.getElementById("startBtn");
const countdown=document.getElementById("countdown");
const info=document.getElementById("infoText");

let audioCtx;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==="suspended")audioCtx.resume();}
function beep(){try{initAudio();const a=audioCtx.createOscillator(),g=audioCtx.createGain();a.type="square";a.connect(g).connect(audioCtx.destination);a.start();setTimeout(()=>{a.stop()},120);}catch{}}

async function startCamera(){await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:false}).then(s=>{cam.srcObject=s;cam.play();});}
async function startMic(){await navigator.mediaDevices.getUserMedia({audio:true});}

function showOverlay(t){msg.textContent=t;overlay.classList.remove("hidden");}
function hideOverlay(){overlay.classList.add("hidden");}

let state="WELCOME";
function mix(){const M=CONFIG.LAYERS[state];cam.style.opacity=M.CAMERA;ninja.style.opacity=M.NINJA;}

function onPress(el,fn){let f=false;const wrap=e=>{if(f)return;f=true;e.preventDefault();fn();};el.addEventListener("touchend",wrap,{once:true,passive:false});el.addEventListener("click",wrap,{once:true});}

onPress(window,async()=>{
  info.style.display="none";
  initAudio();
  await startCamera();
  await startMic(); // 🎧 첫 클릭 시 사운드 허용 요청
  if(!ninja.src)ninja.src=`https://vdo.ninja/?view=${CONFIG.ROOM_ID}&clean&autostart&noaudio&solo&transparent=1`;
  mix();
  showOverlay("WELCOME TO LIMENWALKER WORKSHOP");
  setTimeout(()=>{beep();msg.textContent="";startBtn.style.display="inline-block";},3000);
});

onPress(startBtn,()=>{
  beep();startBtn.style.display="none";
  showOverlay("이제 공간을 걸어보세요.");setTimeout(()=>hideOverlay(),3000);
});

})();
</script>
</body>
</html>
