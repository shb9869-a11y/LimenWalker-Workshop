<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>LIMENWALKER WORKSHOP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --vwpx:100vw; --vhpx:100vh;
    --gap:32px; --line-color:rgba(255,255,255,.9);
    --line-w:1px; --line-r:2px;
    --ff:"Courier New", Courier, monospace;
  }
  html,body{
    margin:0;height:100%;background:#000;color:#fff;
    font-family:var(--ff); overflow:hidden;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  *,*::before,*::after{ box-sizing:border-box; font-family:var(--ff); }
  button,input,select,textarea{ font:inherit; color:inherit; }

  /* 레이어: 카메라(0) ← 궤적(2) ← 레졸룸(4) ← UI(10) */
  #cameraView{
    position:fixed; inset:0; width:var(--vwpx); height:var(--vhpx);
    object-fit:cover; background:#000; z-index:0;
    filter:grayscale(1) contrast(1.2);
    will-change:transform, opacity; transform:translateZ(0); backface-visibility:hidden;
  }
  #trailCanvas{
    position:fixed; inset:0; width:var(--vwpx); height:var(--vhpx);
    z-index:2; pointer-events:none; background:transparent; will-change:opacity;
  }
  #ninjaOverlay{
    position:fixed; left:50%; top:50%;
    width:var(--vwpx); height:var(--vhpx);
    transform:translate(-50%,-50%) scale(1); transform-origin:50% 50%;
    border:0; background:transparent; image-rendering:auto;
    z-index:4; pointer-events:none; opacity:0; transition:opacity .25s ease;
    mix-blend-mode: screen; /* 악몽 감각 */
    will-change:opacity, transform;
  }

  .proscenium{
    position:fixed;
    left:calc(var(--gap) + env(safe-area-inset-left));
    right:calc(var(--gap) + env(safe-area-inset-right));
    top:calc(var(--gap) + env(safe-area-inset-top));
    bottom:calc(var(--gap) + env(safe-area-inset-bottom));
    border:var(--line-w) solid var(--line-color);
    border-radius:var(--line-r);
    pointer-events:none; z-index:5;
  }

  /* 중앙 안내(작게 + 중앙 고정) */
  #infoText, #overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center;
  }
  #infoText{
    font-size:clamp(12px,1.8vmin,16px); opacity:.9; z-index:8; pointer-events:auto;
  }
  #overlay{
    background:rgba(0,0,0,.65);
    z-index:10; line-height:1.55; transition:opacity .25s ease;
  }
  #overlay.hidden{ opacity:0; pointer-events:none; }
  .centerText{ text-align:center; white-space:pre-line; font-size:clamp(13px,1.9vmin,17px); }
  .stageText{ text-align:left; white-space:pre-line; max-width:90vw; font-size:clamp(12px,1.7vmin,16px); }
  .stageBtn{
    border:1px solid #fff; background:transparent; color:#fff;
    padding:.5em 1.1em; text-transform:uppercase; margin-top:14px;
    font-size:clamp(12px,1.7vmin,16px); cursor:pointer;
  }
  #countdown{ font-size:clamp(11px,1.6vmin,15px); opacity:.8; margin-top:12px; display:none; }

  /* 우측 하단 180초 타이머 */
  #cornerTimer{
    position:fixed;
    right:calc(12px + env(safe-area-inset-right));
    bottom:calc(10px + env(safe-area-inset-bottom));
    z-index:20;
    font-size:clamp(12px,1.8vmin,16px);
    opacity:.95;
    background:rgba(0,0,0,.35);
    padding:6px 10px;
    border:1px solid rgba(255,255,255,.6);
    border-radius:6px;
    pointer-events:none;
    display:none;
  }

  /* HTTPS 안내 패널 */
  #httpsBlock{
    position:fixed; inset:0; z-index:200; display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.88); color:#fff; text-align:center; padding:20px;
  }
  #httpsInner{ max-width:560px; }
  .kbd{ display:inline-block; border:1px solid #888; padding:2px 6px; border-radius:4px; background:#111 }
  .uiBtn{ padding:.4em .8em; cursor:pointer; background:transparent; color:#fff; border:1px solid #fff; margin:6px; }
</style>
</head>
<body>

<video id="cameraView" autoplay muted playsinline></video>
<canvas id="trailCanvas"></canvas>

<iframe id="ninjaOverlay"
  allow="autoplay; camera; microphone; fullscreen; clipboard-read; clipboard-write"
  allowtransparency="true" referrerpolicy="no-referrer" src="about:blank">
</iframe>

<div class="proscenium" aria-hidden="true"></div>

<div id="infoText">
  화면을 한번 탭하면 카메라/마이크/센서 권한을 요청합니다.
  <button id="kickoff" class="stageBtn" style="margin-top:16px">TAP TO START</button>
</div>

<div id="overlay" class="hidden">
  <div id="msg" class="centerText"></div>
  <button id="startBtn" class="stageBtn" style="display:none;">PRESS HERE TO START</button>
  <div id="countdown"></div>
</div>

<!-- 180초 타이머 -->
<div id="cornerTimer">03:00</div>

<!-- HTTPS 안내 -->
<div id="httpsBlock">
  <div id="httpsInner">
    <div style="font-size:18px;margin-bottom:10px"><b>보안 연결(HTTPS)이 필요합니다</b></div>
    <div style="opacity:.9">HTTP 환경에서는 카메라/마이크 권한이 차단됩니다.</div>
    <div style="margin:12px 0 8px">아래 주소로 접속해주세요:</div>
    <div id="httpsUrlBox" class="kbd" style="user-select:all;display:inline-block;"></div>
    <div style="margin-top:12px">
      <button id="copyHttps" class="uiBtn">주소 복사</button>
      <button id="openHttps" class="uiBtn">열기</button>
    </div>
  </div>
</div>

<script>
(()=> {
/* ===== Config ===== */
const CONFIG = {
  ROOM_ID: "YOURROOMID",
  HTTPS_ORIGIN: "",         // 필요하면 여기 https 도메인 적기 (예: "https://yourdomain.com")
  REZ_SCALE: 0.65,
  LINE_WIDTH: 0.6,
  LINE_DASH: [1.5,10],
  LAYERS: {
    WELCOME: { CAMERA: 1.00, NINJA: 0.50, TRAIL: 0.00 },
    GUIDE:   { CAMERA: 1.00, NINJA: 0.50, TRAIL: 0.00 },
    EXP:     { CAMERA: 0.95, NINJA: 0.45, TRAIL: 0.95 }, // 3분 탐사
  }
};

/* ===== HTTPS 가드 ===== */
const httpsBlock = document.getElementById('httpsBlock');
const httpsBox = document.getElementById('httpsUrlBox');
const btnCopy = document.getElementById('copyHttps');
const btnOpen = document.getElementById('openHttps');
function isLocalHost(){ return /^(localhost|127\.0\.0\.1)$/i.test(location.hostname); }
function shouldForceHttps(){ return !window.isSecureContext && !isLocalHost(); }
function tryHttpsRedirect(){
  if(shouldForceHttps()){
    if(CONFIG.HTTPS_ORIGIN){
      const t=new URL(location.href), o=CONFIG.HTTPS_ORIGIN.replace(/\/+$/,'');
      location.replace(o+t.pathname+t.search+t.hash);
      return true;
    }else{
      httpsBox.textContent = location.href.replace(/^http:/,'https:');
      httpsBlock.style.display='flex';
      return false;
    }
  }
  return false;
}
if(shouldForceHttps()) tryHttpsRedirect();
btnCopy?.addEventListener('click', async ()=>{ const url=httpsBox.textContent; try{ await navigator.clipboard.writeText(url); alert('복사되었습니다'); }catch{ alert(url); }});
btnOpen?.addEventListener('click', ()=>{ location.href=httpsBox.textContent; });

/* ===== Elements ===== */
const camView   = document.getElementById('cameraView');
const trail     = document.getElementById('trailCanvas');
const tctx      = trail.getContext('2d');
const ninja     = document.getElementById('ninjaOverlay');
const overlay   = document.getElementById('overlay');
const msg       = document.getElementById('msg');
const startBtn  = document.getElementById('startBtn');
const infoText  = document.getElementById('infoText');
const kickoff   = document.getElementById('kickoff');
const countdown = document.getElementById('countdown');
const cornerTimer = document.getElementById('cornerTimer');

/* ===== Viewport fix ===== */
function setViewportVars(){
  const vv = window.visualViewport;
  const w = Math.round((vv?.width || innerWidth));
  const h = Math.round((vv?.height || innerHeight));
  document.documentElement.style.setProperty('--vwpx', w + 'px');
  document.documentElement.style.setProperty('--vhpx', h + 'px');

  const dpr = Math.max(1, devicePixelRatio || 1);
  trail.width  = Math.floor(w * dpr);
  trail.height = Math.floor(h * dpr);
  trail.style.width  = w + 'px';
  trail.style.height = h + 'px';
  tctx.setTransform(dpr,0,0,dpr,0,0);
}
setViewportVars();
addEventListener('resize', setViewportVars);
if (visualViewport){
  visualViewport.addEventListener('resize', setViewportVars);
  visualViewport.addEventListener('scroll', setViewportVars);
}
addEventListener('orientationchange', ()=> setTimeout(setViewportVars,120));
addEventListener('pageshow', ()=>{ setTimeout(()=>{ setViewportVars(); applyRezScale(); }, 60); });

/* ===== Audio ===== */
let audioCtx;
function initAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
}
function beep(freq=880, dur=120){
  try{
    initAudioContext();
    const osc = audioCtx.createOscillator(), g = audioCtx.createGain();
    osc.type='square'; osc.frequency.value=freq; g.gain.value=0.0001;
    osc.connect(g).connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.25,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur/1000);
    osc.start(t); osc.stop(t+dur/1000+0.02);
  }catch{}
}

/* ===== Wake Lock ===== */
let wakeLock = null;
async function keepScreenOn(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      document.addEventListener('visibilitychange', async ()=>{
        if(document.visibilityState==='visible' && !wakeLock){
          try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{}
        }
      });
    }
  }catch{}
}

/* ===== Overlay helpers ===== */
function showOverlayText(text, center=true){
  msg.className = center ? 'centerText' : 'stageText';
  msg.textContent = text;
  overlay.classList.remove('hidden');
}
function hideOverlay(){ overlay.classList.add('hidden'); }

/* ===== VDO.Ninja ===== */
const injectedCss = encodeURIComponent(`
  html,body{background:transparent!important;margin:0!important;overflow:hidden!important;}
  #container,.container{background:transparent!important;}
  video,canvas{position:fixed!important; inset:0!important; width:100vw!important; height:100vh!important; object-fit:cover!important; background:transparent!important;}
`);
const ninjaBase = `https://vdo.ninja/?view=${encodeURIComponent(CONFIG.ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo&transparent=1&css=${injectedCss}`;
const ninjaUrl  = () => `${ninjaBase}&ts=${Date.now()}`;

/* Rez scale */
function applyRezScale(){
  const s = Math.max(0.2, Math.min(1, Number(CONFIG.REZ_SCALE)||1));
  ninja.style.width  = `calc(var(--vwpx) * ${s})`;
  ninja.style.height = `calc(var(--vhpx) * ${s})`;
  ninja.style.left = '50%'; ninja.style.top = '50%';
  ninja.style.transform = `translate(-50%,-50%) scale(${1/s})`;
}
applyRezScale();

/* 선로딩 (보이지 않아도 먼저 연결) */
(function preloadOverlay(){
  if(!ninja.src || ninja.src === 'about:blank'){ ninja.src = ninjaUrl(); }
})();
setInterval(()=>{ if(parseFloat(getComputedStyle(ninja).opacity)||0){ ninja.src = ninjaUrl(); } }, 60000);

/* ===== Layer ratio control ===== */
let state = 'WELCOME';
function applyLayerMix(){
  const M = CONFIG.LAYERS[state] || CONFIG.LAYERS.WELCOME;
  camView.style.opacity = String(M.CAMERA);
  ninja.style.opacity   = String(M.NINJA);
  trail.style.opacity   = String(M.TRAIL);
}

/* ===== Sensors & Trajectory ===== */
let points = [];
let drawingEnabled = false;
let metersPerPixel = 1.2;
const MAX_POINTS = 2500;
const DECAY_START = 10_000, MAX_AGE = 60_000, MAX_JITTER = 18;
let motionMag = 0, firstFix = null;

function onMotion(e){
  const ax=e.accelerationIncludingGravity?.x||0, ay=e.accelerationIncludingGravity?.y||0, az=e.accelerationIncludingGravity?.z||0;
  motionMag = motionMag * 0.9 + Math.hypot(ax,ay,az) * 0.1;
}
function enableMotionIfNeeded(){
  try{
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
      DeviceMotionEvent.requestPermission().catch(()=>{});
    }
  }catch{}
  addEventListener('devicemotion', onMotion, {passive:true});
}
const M_PER_DEG = 111320;
function llToMeters(lat0, lon0, lat, lon){
  const x = (lon - lon0) * Math.cos(lat0 * Math.PI/180) * M_PER_DEG;
  const y = (lat - lat0) * M_PER_DEG;
  return {x, y};
}
function metersToCanvas(xm, ym){
  const w = trail.clientWidth, h = trail.clientHeight;
  const cx = w/2, cy = h/2;
  return { x: cx + xm / metersPerPixel, y: cy - ym / metersPerPixel };
}
function startGPS(){
  if(!('geolocation' in navigator)) return;
  firstFix = null;
  navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat, longitude:lon, speed} = pos.coords;
      if(!firstFix){ firstFix = {lat, lon}; }
      const m = llToMeters(firstFix.lat, firstFix.lon, lat, lon);
      const p = metersToCanvas(m.x, m.y);
      points.push({ x:p.x, y:p.y, t:performance.now(), speed:(Number.isFinite(speed)?speed:0)||0 });
      if(points.length > MAX_POINTS) points.shift();
    }, ()=>{}, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
  );
}
function jitterFor(age){
  const frac = Math.min(1, Math.max(0, (age-DECAY_START)/(MAX_AGE-DECAY_START)));
  const motionBoost = Math.min(1, Math.max(0, (motionMag-5)/10));
  return (MAX_JITTER * frac) * (0.5 + 0.5*motionBoost);
}
function drawTrajectory(){
  const now = performance.now();
  tctx.fillStyle = 'rgba(0,0,0,0.06)';
  tctx.fillRect(0,0,trail.clientWidth, trail.clientHeight);
  if(points.length < 2 || !drawingEnabled) return;
  tctx.save();
  tctx.lineWidth = CONFIG.LINE_WIDTH;
  tctx.setLineDash(CONFIG.LINE_DASH);
  for(let i=1;i<points.length;i++){
    const a = points[i-1], b = points[i];
    const age = now - b.t; if(age > MAX_AGE) continue;
    const alpha = age <= DECAY_START ? 0.9 : Math.max(0, 0.9 * (1 - (age-DECAY_START)/(MAX_AGE-DECAY_START)));
    const j = age > DECAY_START ? jitterFor(age) : 0;
    const jx1=(Math.random()-0.5)*2*j, jy1=(Math.random()-0.5)*2*j;
    const jx2=(Math.random()-0.5)*2*j, jy2=(Math.random()-0.5)*2*j;
    tctx.strokeStyle = `rgba(255,255,255,${alpha})`;
    tctx.beginPath();
    tctx.moveTo(a.x + jx1, a.y + jy1);
    tctx.lineTo(b.x + jx2, b.y + jy2);
    tctx.stroke();
  }
  tctx.restore();
  const cutoff = now - MAX_AGE;
  if(points.length && points[0].t < cutoff){
    let idx=0; while(idx < points.length && points[idx].t < cutoff) idx++;
    if(idx>0) points.splice(0, idx);
  }
}
let rafId=null; function loop(){ drawTrajectory(); rafId = requestAnimationFrame(loop); }

/* ===== Media (카메라/마이크) + 워치독 ===== */
let currentStream = null, ensureTimer = null, restartTimer = null;
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:"environment" } }, audio:false });
  currentStream = stream;
  camView.srcObject = stream;
  camView.muted = true;
  camView.setAttribute('playsinline','');
  camView.load();
  try { await camView.play(); } catch {}
  bindTrackGuards(stream);
  pingEnsurePlaying();
}
async function startMic(){ try{ await navigator.mediaDevices.getUserMedia({ audio:true }); }catch{} }
function bindTrackGuards(stream){
  stream.getVideoTracks().forEach(tr=>{
    tr.onended  = ()=>{ restartCameraSoon(); };
    tr.onmute   = ()=>{ pingEnsurePlaying(); };
    tr.onunmute = ()=>{ pingEnsurePlaying(); };
  });
}
function restartCameraSoon(ms=350){
  if(restartTimer) return;
  restartTimer = setTimeout(async ()=>{
    restartTimer=null;
    try{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); }catch{}
    currentStream=null;
    try{ await startCamera(); }catch(e){ console.error('restart camera fail',e); }
  }, ms);
}
function pingEnsurePlaying(){
  if(ensureTimer) return;
  ensureTimer = setInterval(()=>{
    if(camView.readyState >= 2 && camView.paused){ camView.play().catch(()=>{}); }
    const ok = currentStream && currentStream.getVideoTracks().some(t=>t.readyState==='live');
    if(!ok) restartCameraSoon(100);
  }, 1000);
}

/* ===== Input binder (pointerup 우선) ===== */
function onPress(el, handler){
  let fired=false;
  const onceWrap=(e)=>{ if(fired) return; fired=true; handler(e); };
  // pointerup이 있으면 이걸 우선 사용 (iOS/안드 모두 안정적)
  el.addEventListener('pointerup', onceWrap, { once:true });
  // 보조: 일부 환경에서 pointer 이벤트가 비활성일 때 click 사용
  el.addEventListener('click', onceWrap, { once:true });
}

/* ===== 180초 타이머 ===== */
let exploreTimerId=null, exploreRemain=0;
function fmt(t){ const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
function startExploreTimer(seconds=180){
  exploreRemain=seconds;
  cornerTimer.textContent=fmt(exploreRemain);
  cornerTimer.style.display='block';
  if(exploreTimerId) clearInterval(exploreTimerId);
  exploreTimerId=setInterval(()=>{
    exploreRemain--;
    if(exploreRemain<=0){
      cornerTimer.textContent='00:00';
      clearInterval(exploreTimerId); exploreTimerId=null;
      try{ beep(1046,160); }catch{}
      return;
    }
    cornerTimer.textContent=fmt(exploreRemain);
  },1000);
}

/* ===== Flow ===== */
/* 0) 시작 버튼(안내 패널)에서 권한 요청 */
onPress(kickoff, async ()=>{
  initAudioContext(); keepScreenOn();
  // 안내 패널 숨김
  document.getElementById('infoText').style.display='none';

  // 한 번의 제스처에서 카메라+마이크 권한 요청
  await startCamera().catch(e=>console.error('camera start fail',e));
  await startMic().catch(e=>console.warn('mic denied', e));

  // 센서/위치 + 드로잉 루프
  enableMotionIfNeeded(); startGPS(); if(!rafId) loop();

  // 레졸룸 준비
  applyRezScale();
  if(!ninja.contentWindow) ninja.src = ninjaUrl();

  state='WELCOME'; applyLayerMix();
  stepWelcome();
});

function stepWelcome(){
  showOverlayText('WELCOME TO LIMENWALKER WORKSHOP', true);
  setTimeout(()=>{
    beep(880,120);
    msg.textContent='';
    countdown.style.display='none';
    startBtn.style.display='inline-block';
    state='WELCOME'; applyLayerMix();
  },3000);
}

/* 1) PRESS 버튼 → 60초 가이드 → 3분 탐사 */
let guideTimer=null;
onPress(startBtn, async ()=>{
  if(guideTimer) return;
  beep(660,150);
  startBtn.style.display='none';
  showOverlayText(formatGuide(), false);

  state='GUIDE'; applyLayerMix();

  let sec=60;
  countdown.style.display='block';
  countdown.textContent=`${sec}초 후 탐사가 시작됩니다.`;
  guideTimer=setInterval(()=>{
    sec--;
    countdown.textContent=`${sec}초 후 탐사가 시작됩니다.`;
    if(sec<=0){
      clearInterval(guideTimer); guideTimer=null;
      countdown.style.display='none';
      beginExploration();
    }
  },1000);
});

function beginExploration(){
  drawingEnabled = true;
  hideOverlay();
  state='EXP'; applyLayerMix();
  startExploreTimer(180);
}

/* 안내문 */
function formatGuide(){
  const lines = [
    "안녕하세요. 리멘워커 워크숍의 첫 번째 워크숍 발표를 찾아와주신 여러분에게 감사의 인사를 올립니다.",
    "이곳은 무작위로 수집된 시간이 이성적으로 분류되어 예측가능한 현실로 구성된 공간입니다.",
    "어느 날, 이곳에 존재하던 ‘무작위로 수집된 시간’은 예측가능한 현실로부터 탈출하게 됩니다.",
    "잠시후, 당신의 핸드폰 스크린 위로는 ‘당신이 바라보는 현실 공간’과 ‘이 공간을 탈출한 ‘시간’이 바라보는 공간’이 동시에 투사될 것입니다.",
    "3분 간의 시간 동안 당신은 공간을 자유롭게 거닐며, 이 공간을 탈출한 ‘시간’이 바라보는 공간’이 함께 포착해 나가시면 됩니다."
  ];
  return lines.map((l,i)=>`${i+1}. ${l}`).join("\n\n");
}

/* 복귀/회전 시 재적용 */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){
    setViewportVars(); applyRezScale();
    camView.play().catch(()=>{});
    if(!currentStream){ restartCameraSoon(50); }
    applyLayerMix();
    if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); }
    if(!ninja.contentWindow || ninja.src==='about:blank'){ ninja.src = ninjaUrl(); }
    if(cornerTimer.style.display==='block'){
      cornerTimer.textContent = fmt(Math.max(0, exploreRemain|0));
    }
  }
});
window.addEventListener('orientationchange', ()=>{
  setTimeout(()=>{
    setViewportVars(); applyRezScale();
    camView.play().catch(()=>{});
    if(!currentStream){ restartCameraSoon(50); }
    applyLayerMix();
  },120);
});

/* 루프 시작자 */
let rafId=null; function loop(){ drawTrajectory(); rafId = requestAnimationFrame(loop); }

})();
</script>
</body>
</html>
